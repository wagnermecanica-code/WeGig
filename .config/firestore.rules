rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ============================================
    // HELPER FUNCTIONS
    // ============================================

    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(uid) {
      return request.auth.uid == uid;
    }

    // Verifica se o auth.uid é participante de uma conversa (participants ou profileUid)
    function isConversationMember(conversationId) {
      let conv = get(/databases/$(database)/documents/conversations/$(conversationId));
      return conv.exists() && (
        (conv.data.participants != null && request.auth.uid in conv.data.participants) ||
        (conv.data.profileUid != null && request.auth.uid in conv.data.profileUid)
      );
    }

    // Verifica se o profileId pertence ao usuário autenticado
    function ownsProfile(profileId) {
      let profile = get(/databases/$(database)/documents/profiles/$(profileId));
      return profile.exists() && profile.data.uid == request.auth.uid;
    }

    // ============================================
    // PROFILES - Perfis de usuários (multi-perfil)
    // ============================================

    match /profiles/{profileId} {
      allow read: if isSignedIn();
      allow create, update, delete: if isSignedIn() && request.resource.data.uid == request.auth.uid;
    }

    // ============================================
    // USERS - Dados privados do usuário
    // ============================================

    match /users/{userId} {
      allow read, write: if isSignedIn() && isOwner(userId);
    }

    // ============================================
    // POSTS - Publicações (expiram após 30 dias)
    // ============================================
    // Fields: authorUid (auth UID), authorProfileId (profile ID)

    match /posts/{postId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn()
        && request.resource.data.authorUid == request.auth.uid;
      allow update, delete: if isSignedIn()
        && resource.data.authorUid == request.auth.uid;
    }

    // ============================================
    // CONVERSATIONS - Multi-perfil
    // ============================================
    // Estrutura esperada:
    // - participants: [uid1, uid2] (auth UIDs)
    // - profileUid: [uid1, uid2] (fallback de owners dos perfis)
    // - participantProfiles: [profileId1, profileId2]

    match /conversations/{conversationId} {
      // Para queries: verifica se o usuário está em participants ou profileUid do documento retornado
      // Para leitura de documento específico: usa isConversationMember
      allow read: if isSignedIn() && (
        // Query support: verifica campos do documento retornado (resource.data)
        (resource.data.participants != null && request.auth.uid in resource.data.participants) ||
        (resource.data.profileUid != null && request.auth.uid in resource.data.profileUid)
      );
      allow create: if isSignedIn()
        && request.auth.uid in request.resource.data.participants
        && request.resource.data.participantProfiles != null;
      allow update, delete: if isSignedIn() && (
        (resource.data.participants != null && request.auth.uid in resource.data.participants) ||
        (resource.data.profileUid != null && request.auth.uid in resource.data.profileUid)
      );

      // ============================================
      // MESSAGES - Subcoleção aninhada
      // ============================================
      // Usa isConversationMember para verificar se usuário pertence à conversa pai
      match /messages/{messageId} {
        allow read: if isSignedIn() && isConversationMember(conversationId);
        allow create: if isSignedIn()
          && isConversationMember(conversationId)
          && request.resource.data.senderId == request.auth.uid;
        allow update, delete: if isSignedIn() && resource.data.senderId == request.auth.uid;
      }
    }

    // ============================================
    // INTERESTS - Interesses enviados entre perfis
    // ============================================

    match /interests/{interestId} {
      allow read: if isSignedIn();
      allow create, update: if isSignedIn() && request.resource.data.profileUid == request.auth.uid;
      allow delete: if isSignedIn() && resource.data.profileUid == request.auth.uid;
    }

    // ============================================
    // NOTIFICATIONS - Notificações push/in-app
    // ============================================
    // SECURITY FIX: Valida que recipientProfileId pertence ao recipientUid
    // Previne ataques onde usuário A tenta ler notificações do profileId de usuário B

    match /notifications/{notificationId} {
      allow read: if isSignedIn() 
        && resource.data.recipientUid == request.auth.uid
        && ownsProfile(resource.data.recipientProfileId);
      allow create: if isSignedIn()
        && request.resource.data.recipientProfileId != null
        && request.resource.data.recipientUid != null
        && request.resource.data.recipientUid == request.auth.uid
        && ownsProfile(request.resource.data.recipientProfileId);
      allow update, delete: if isSignedIn() 
        && resource.data.recipientUid == request.auth.uid
        && ownsProfile(resource.data.recipientProfileId);
    }

    // ============================================
    // BLOCKS - Bloqueios de perfis/usuários
    // ============================================
    match /blocks/{blockId} {
      allow read: if isSignedIn() && resource.data.blockedByUid == request.auth.uid;
      allow create: if isSignedIn() && request.resource.data.blockedByUid == request.auth.uid;
      allow update, delete: if isSignedIn() && resource.data.blockedByUid == request.auth.uid;
    }

    // ============================================
    // REPORTS - Denúncias
    // ============================================
    match /reports/{reportId} {
      allow create: if isSignedIn() && request.resource.data.reporterUid == request.auth.uid;
      allow read, update, delete: if isSignedIn() && resource.data.reporterUid == request.auth.uid;
    }
  }
}
