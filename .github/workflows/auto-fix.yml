name: Auto Fix & Analyze

on:
  push:
    branches:
      - dev
      - feat/*
  workflow_dispatch:

jobs:
  analyze-and-fix:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.27.1"
          channel: "stable"
          cache: true

      - name: Install Melos
        run: dart pub global activate melos

      - name: Bootstrap monorepo
        run: melos bootstrap

      - name: Run Flutter Analyze
        run: |
          cd packages/app
          flutter analyze --no-fatal-warnings || true

      - name: Detect Animation Issues
        id: detect
        run: |
          echo "ðŸ” Verificando problemas de ciclo de vida e mixins..."

          echo "## SingleTickerProviderStateMixin encontrados:"
          grep -rn "SingleTickerProviderStateMixin" packages/app/lib/ || echo "Nenhum uso encontrado"

          echo ""
          echo "## Dispose com context inseguro:"
          grep -rn "dispose()" packages/app/lib/ | grep -A 2 "context\." || echo "Nenhum uso inseguro encontrado"

          echo ""
          echo "## Tooltip widgets encontrados:"
          grep -rn "tooltip:" packages/app/lib/ || echo "Nenhum tooltip encontrado"

      - name: Apply Tooltip Fixes
        run: |
          echo "âœ… Removendo tooltips problemÃ¡ticos..."
          # Remove tooltip properties de IconButton
          find packages/app/lib/ -type f -name "*.dart" -exec sed -i.bak '/tooltip: /d' {} +
          find packages/app/lib/ -type f -name "*.dart.bak" -delete

      - name: Run Tests
        run: |
          cd packages/app
          flutter test --no-pub || true

      - name: Check for changes
        id: git-check
        run: |
          git diff --exit-code || echo "changes=true" >> $GITHUB_OUTPUT

      - name: Commit and push if changed
        if: steps.git-check.outputs.changes == 'true'
        run: |
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "actions@github.com"
          git add .
          git commit -m "ðŸ¤– Auto-fix: Remove tooltips problemÃ¡ticos"
          git push
