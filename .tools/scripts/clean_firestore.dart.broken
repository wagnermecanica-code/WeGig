/// Script para limpar todo o Firestore (desenvolvimento apenas!)
/// Use apenas em ambiente de dev/staging, NUNCA em produÃ§Ã£o
/// 
/// IMPORTANTE: Este script nÃ£o pode ser executado diretamente com dart run
/// porque precisa das configuraÃ§Ãµes do Firebase da plataforma.
/// 
/// OPÃ‡Ã•ES PARA LIMPAR O FIRESTORE:
/// 
/// 1. Via Firebase Console (MAIS FÃCIL):
///    - Acesse: https://console.firebase.google.com/project/to-sem-banda-83e19/firestore
///    - Para cada coleÃ§Ã£o (users, posts, profiles, etc):
///      â€¢ Click nos 3 pontinhos ao lado do nome
///      â€¢ "Delete collection"
///      â€¢ Confirmar
/// 
/// 2. Via Firebase CLI (RECOMENDADO):
///    Execute no terminal:
///    firebase firestore:delete --all-collections --project to-sem-banda-83e19
/// 
/// 3. Manualmente via cÃ³digo (se tiver poucos docs):
///    - Abra o Firebase Console
///    - Delete documentos individuais
void main() {
  print('ğŸ—‘ï¸  COMO LIMPAR O FIRESTORE\n');
  print('OPÃ‡ÃƒO 1 - Firebase Console (Visual):');
  print('  1. Acesse: https://console.firebase.google.com/project/to-sem-banda-83e19/firestore');
  print('  2. Para cada coleÃ§Ã£o: click nos 3 pontinhos â†’ Delete collection\n');
  
  print('OPÃ‡ÃƒO 2 - Firebase CLI (RÃ¡pido):');
  print('  Execute no terminal:');
  print('  firebase firestore:delete --all-collections --project to-sem-banda-83e19\n');
  
  print('âš ï¸  ApÃ³s limpar, execute:');
  print('  1. firebase deploy --only firestore:rules');
  print('  2. firebase deploy --only firestore:indexes');
}

    final collections = [
      'users',
      'posts',
      'profiles',
      'conversations',
      'notifications',
      'interests',
      'bands',
      'chats',
    ];

    int totalDeleted = 0;

    for (final collectionName in collections) {
      try {
        print('Processando $collectionName/...');
        final snapshot = await firestore.collection(collectionName).get();
        
        if (snapshot.docs.isEmpty) {
          print('  â””â”€ Vazia, pulando\n');
          continue;
        }

        // Deletar documentos em batch de 500 (limite Firestore)
        final batch = firestore.batch();
        int batchCount = 0;

        for (final doc in snapshot.docs) {
          batch.delete(doc.reference);
          batchCount++;
          totalDeleted++;

          // Commit batch a cada 500 docs
          if (batchCount >= 500) {
            await batch.commit();
            batchCount = 0;
          }
        }

        // Commit batch restante
        if (batchCount > 0) {
          await batch.commit();
        }

        print('  â””â”€ âœ“ Deletados ${snapshot.docs.length} documentos\n');

        // Deletar subcoleÃ§Ãµes (messages dentro de conversations)
        if (collectionName == 'conversations') {
          print('  â””â”€ Deletando subcoleÃ§Ã£o messages/...');
          int messagesDeleted = 0;
          
          for (final conversationDoc in snapshot.docs) {
            final messagesSnapshot = await conversationDoc.reference
                .collection('messages')
                .get();
            
            for (final messageDoc in messagesSnapshot.docs) {
              await messageDoc.reference.delete();
              messagesDeleted++;
            }
          }
          
          if (messagesDeleted > 0) {
            print('  â””â”€ âœ“ Deletadas $messagesDeleted mensagens\n');
            totalDeleted += messagesDeleted;
          }
        }
      } catch (e) {
        print('  â””â”€ âš ï¸  Erro ao deletar $collectionName: $e\n');
      }
    }

    print('\nâœ… Firestore limpo!');
    print('ğŸ“Š Total de documentos deletados: $totalDeleted\n');
    print('ğŸš€ PrÃ³ximo passo: firebase deploy --only firestore:rules');
    print('   Depois: flutter run (app criarÃ¡ estrutura nova)\n');
  } catch (e) {
    print('\nâŒ Erro fatal: $e');
    print('ğŸ’¡ Tente limpar manualmente via Firebase Console');
  }
}
